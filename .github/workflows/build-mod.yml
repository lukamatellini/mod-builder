name: Build Minecraft Mod (Main-Controlled)
on:
  workflow_dispatch:
    inputs:
      build_ref:
        description: "Branch to build (e.g. build/<id>/<timestamp>)"
        required: true
        type: string
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    steps:
      # ----------------------------
      # 1) Checkout generated mod (the build/** branch passed in)
      # ----------------------------
      - name: Checkout generated mod project
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.build_ref }}
          fetch-depth: 1
      # ----------------------------
      # 2) Setup Node (JSON parsing)
      # ----------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      # ----------------------------
      # 3) Ensure unzip + file exist (for wrapper inspection)
      # ----------------------------
      - name: Ensure unzip + file are available
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y unzip file
      # ----------------------------
      # 4) Read build-config.json
      # ----------------------------
      - name: Read build-config.json
        id: buildconfig
        run: |
          set -e
          node -e "
            const fs = require('fs');
            const path = 'build-config.json';
            if (!fs.existsSync(path)) throw new Error('Missing build-config.json (Lovable must generate this)');
            const cfg = JSON.parse(fs.readFileSync(path, 'utf8'));
            if (!cfg.webhookUrl) throw new Error('build-config.json missing webhookUrl');
            if (!cfg.webhookSecret) throw new Error('build-config.json missing webhookSecret'); // ✅ NEW (critical)
            if (!cfg.loader) throw new Error('build-config.json missing loader');
            if (!cfg.mcVersion) throw new Error('build-config.json missing mcVersion');
            const out = process.env.GITHUB_OUTPUT;
            fs.appendFileSync(out, 'webhookUrl=' + cfg.webhookUrl + '\\n');
            fs.appendFileSync(out, 'webhookSecret=' + cfg.webhookSecret + '\\n'); // ✅ NEW (critical)
            fs.appendFileSync(out, 'loader=' + cfg.loader + '\\n');
            fs.appendFileSync(out, 'mcVersion=' + cfg.mcVersion + '\\n');
            console.log('::add-mask::' + cfg.webhookSecret); // ✅ NEW (safe logs)
          "
      # ----------------------------
      # 5) Guardrails (platform rules)
      # ----------------------------
      - name: Guardrails from build-config.json
        run: |
          set -e
          if [ "${{ steps.buildconfig.outputs.loader }}" != "fabric" ]; then
            echo "ERROR: loader must be fabric"
            exit 1
          fi
          case "${{ steps.buildconfig.outputs.mcVersion }}" in
            1.21.*) echo "OK: mcVersion ${{ steps.buildconfig.outputs.mcVersion }}" ;;
            *) echo "ERROR: mcVersion must be 1.21.x"; exit 1 ;;
          esac
      # ----------------------------
      # 6) Validate fabric.mod.json
      # ----------------------------
      - name: Validate fabric.mod.json
        id: modmeta
        run: |
          set -e
          node -e "
            const fs = require('fs');
            const p = 'src/main/resources/fabric.mod.json';
            if (!fs.existsSync(p)) throw new Error('Missing ' + p);
            const meta = JSON.parse(fs.readFileSync(p, 'utf8'));
            if (!meta.id) throw new Error('fabric.mod.json missing id');
            if (!meta.depends || !meta.depends.minecraft) throw new Error('fabric.mod.json missing depends.minecraft');
            const mc = String(meta.depends.minecraft).replace(/\\s+/g,'');
            if (!(mc.includes('>=1.21') && mc.includes('<1.22'))) {
              throw new Error('Minecraft range must be >=1.21 <1.22');
            }
            const out = process.env.GITHUB_OUTPUT;
            fs.appendFileSync(out, 'modid=' + meta.id + '\\n');
          "
      # ----------------------------
      # 7) Java + Gradle (ensure `gradle` exists)
      # ----------------------------
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
      - name: Setup Gradle (for wrapper generation)
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: "8.8"
      # ----------------------------
      # 8) Ensure Gradle wrapper exists
      # ----------------------------
      - name: Ensure Gradle wrapper exists
        run: |
          set -e
          if [ ! -f "./gradlew" ]; then
            echo "No ./gradlew found — generating wrapper with Gradle 8.8"
            gradle wrapper --gradle-version 8.8
          fi
          chmod +x ./gradlew
          echo "=== wrapper folder ==="
          ls -lah gradle/wrapper || true
      # ----------------------------
      # 9) Wrapper sanity check (optional, but useful)
      # ----------------------------
      - name: Validate Gradle wrapper jar
        run: |
          set -e
          test -f ./gradlew || (echo "ERROR: gradlew missing" && exit 1)
          test -f gradle/wrapper/gradle-wrapper.properties || (echo "ERROR: gradle-wrapper.properties missing" && exit 1)
          test -f gradle/wrapper/gradle-wrapper.jar || (echo "ERROR: gradle-wrapper.jar missing" && exit 1)
          file gradle/wrapper/gradle-wrapper.jar || true
          unzip -l gradle/wrapper/gradle-wrapper.jar | grep -q "org/gradle/wrapper/GradleWrapperMain.class" \
            && echo "OK: GradleWrapperMain present" \
            || (echo "ERROR: GradleWrapperMain NOT in jar (jar corrupt/wrong)" && exit 1)
      # ----------------------------
      # 10) Build mod (WRAPPER ONLY)
      # ----------------------------
      - name: Build mod with Gradle
        id: build
        run: |
          set -e
          ./gradlew --version
          ./gradlew clean build remapJar --no-daemon --info
          echo "Build output:"
          ls -lah build/libs || true
          JAR_FILE=$(ls -1S build/libs/*.jar \
            | grep -vE '(sources|javadoc|dev)\.jar$' \
            | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "ERROR: No distributable jar produced"
            exit 1
          fi
          echo "jar_file=$JAR_FILE" >> "$GITHUB_OUTPUT"
          echo "jar_name=$(basename "$JAR_FILE")" >> "$GITHUB_OUTPUT"
      # ----------------------------
      # 11) HARD validation (real mod)
      # ----------------------------
      - name: Validate real mod jar
        env:
          MODID: ${{ steps.modmeta.outputs.modid }}
          JAR: ${{ steps.build.outputs.jar_file }}
        run: |
          set -e
          unzip -l "$JAR" | grep -q "fabric.mod.json" || (echo "Missing fabric.mod.json in jar" && exit 1)
          unzip -l "$JAR" | grep -q "\.class$" || (echo "No compiled classes in jar" && exit 1)
          unzip -l "$JAR" | grep -q "build-plan.json" || (echo "Missing build-plan.json in jar" && exit 1)
          unzip -l "$JAR" | grep -q "assets/$MODID/" || (echo "Missing assets/$MODID/" && exit 1)
          unzip -l "$JAR" | grep -q "data/$MODID/" || (echo "Missing data/$MODID/" && exit 1)
      # ----------------------------
      # 12) Upload artifact
      # ----------------------------
      - name: Upload mod jar
        uses: actions/upload-artifact@v4
        with:
          name: minecraft-mod
          path: ${{ steps.build.outputs.jar_file }}
      # ----------------------------
      # 13) Webhook success
      # ----------------------------
      - name: Notify webhook (success)
        if: success()
        run: |
          set -e
          curl -X POST "${{ steps.buildconfig.outputs.webhookUrl }}" \
            -H "Content-Type: application/json" \
            -H "x-webhook-secret: ${{ steps.buildconfig.outputs.webhookSecret }}" \  # ✅ NEW (critical)
            -d "{\"status\":\"success\",\"modId\":\"${{ steps.modmeta.outputs.modid }}\",\"branch\":\"${{ inputs.build_ref }}\",\"commit\":\"${GITHUB_SHA}\"}"
      # ----------------------------
      # 14) Webhook failure (safe)
      # ----------------------------
      - name: Notify webhook (failure)
        if: failure()
        run: |
          set -e
          WEBHOOK="${{ steps.buildconfig.outputs.webhookUrl }}"
          if [ -z "$WEBHOOK" ]; then
            echo "No webhookUrl available; skipping webhook."
            exit 0
          fi
          curl -X POST "$WEBHOOK" \
            -H "Content-Type: application/json" \
            -H "x-webhook-secret: ${{ steps.buildconfig.outputs.webhookSecret }}" \  # ✅ NEW (critical)
            -d "{\"status\":\"failed\",\"branch\":\"${{ inputs.build_ref }}\",\"commit\":\"${GITHUB_SHA}\"}"

