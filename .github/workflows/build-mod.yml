name: Build Minecraft Mod (Main-Controlled)

on:
  workflow_dispatch:
    inputs:
      build_ref:
        description: "Branch to build (e.g. build/<id>/<timestamp>)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      # ----------------------------
      # 1) Checkout generated mod project
      # ----------------------------
      - name: Checkout generated mod project
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.build_ref }}
          fetch-depth: 1

      # ----------------------------
      # 2) Setup Node (JSON parsing)
      # ----------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ----------------------------
      # 3) Ensure tools are available (unzip/file/pip/jq)
      # ----------------------------
      - name: Ensure unzip + file + jq are available
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y unzip file python3-pip jq

      # ----------------------------
      # 4) Read build-config.json (includes modId + webhookSecret)
      # ----------------------------
      - name: Read build-config.json
        id: buildconfig
        run: |
          set -e
          node -e "
            const fs = require('fs');
            const path = 'build-config.json';
            if (!fs.existsSync(path)) throw new Error('Missing build-config.json');
            const cfg = JSON.parse(fs.readFileSync(path, 'utf8'));
            if (!cfg.modId) throw new Error('build-config.json missing modId (DB UUID)');
            if (!cfg.webhookUrl) throw new Error('build-config.json missing webhookUrl');
            if (!cfg.webhookSecret) throw new Error('build-config.json missing webhookSecret');
            if (!cfg.loader) throw new Error('build-config.json missing loader');
            if (!cfg.mcVersion) throw new Error('build-config.json missing mcVersion');
            const url = String(cfg.webhookUrl).trim();
            if (!/^https?:\\/\\//.test(url)) throw new Error('webhookUrl must start with http:// or https://');
            const modUuid = String(cfg.modId).trim();
            const uuidRe = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/;
            if (!uuidRe.test(modUuid)) throw new Error('modId is not a valid UUID: ' + modUuid);
            console.log('::add-mask::' + String(cfg.webhookSecret).trim());
            const out = process.env.GITHUB_OUTPUT;
            fs.appendFileSync(out, 'modUuid=' + modUuid + '\\n');
            fs.appendFileSync(out, 'webhookUrl=' + url + '\\n');
            fs.appendFileSync(out, 'webhookSecret=' + String(cfg.webhookSecret).trim() + '\\n');
            fs.appendFileSync(out, 'loader=' + String(cfg.loader).trim() + '\\n');
            fs.appendFileSync(out, 'mcVersion=' + String(cfg.mcVersion).trim() + '\\n');
            fs.appendFileSync(out, 'modName=' + String(cfg.modName || 'Minecraft Mod').trim() + '\\n');
          "

      # ----------------------------
      # 5) Guardrails (platform rules)
      # ----------------------------
      - name: Guardrails from build-config.json
        run: |
          set -e
          if [ "${{ steps.buildconfig.outputs.loader }}" != "fabric" ]; then
            echo "ERROR: loader must be fabric"
            exit 1
          fi
          case "${{ steps.buildconfig.outputs.mcVersion }}" in
            1.21.*) echo "OK: mcVersion ${{ steps.buildconfig.outputs.mcVersion }}" ;;
            *) echo "ERROR: mcVersion must be 1.21.x"; exit 1 ;;
          esac

      # ----------------------------
      # 6) Validate fabric.mod.json
      # ----------------------------
      - name: Validate fabric.mod.json
        id: modmeta
        run: |
          set -e
          node -e "
            const fs = require('fs');
            const p = 'src/main/resources/fabric.mod.json';
            if (!fs.existsSync(p)) throw new Error('Missing ' + p);
            const meta = JSON.parse(fs.readFileSync(p, 'utf8'));
            if (!meta.id) throw new Error('fabric.mod.json missing id');
            if (!meta.depends || !meta.depends.minecraft) throw new Error('fabric.mod.json missing depends.minecraft');
            const mc = String(meta.depends.minecraft).replace(/\\s+/g,'');
            if (!(mc.includes('>=1.21') && mc.includes('<1.22'))) {
              throw new Error('Minecraft range must be >=1.21 <1.22');
            }
            const out = process.env.GITHUB_OUTPUT;
            fs.appendFileSync(out, 'modid=' + meta.id + '\\n');
          "

      # ----------------------------
      # 6b) Verify build-plan.json exists (early sanity check)
      # ----------------------------
      - name: Verify build-plan.json exists
        run: |
          set -e
          if [ ! -f "src/main/resources/build-plan.json" ]; then
            echo "ERROR: build-plan.json not found in source tree"
            echo "This indicates a template engine failure - the mod cannot be built"
            exit 1
          fi
          echo "OK: build-plan.json found"

      # ----------------------------
      # 6c) Verify source files exist
      # ----------------------------
      - name: Verify source files exist
        env:
          MODID: ${{ steps.modmeta.outputs.modid }}
        run: |
          set -e
          MAIN_CLASS=$(find src/main/java -name "*.java" -type f | head -1)
          if [ -z "$MAIN_CLASS" ]; then
            echo "ERROR: No Java source files found"
            exit 1
          fi
          echo "OK: Found source files"

          if [ ! -d "src/main/resources/assets/$MODID" ]; then
            echo "ERROR: Missing assets directory for mod $MODID"
            exit 1
          fi
          echo "OK: Assets directory found"

          if [ ! -d "src/main/resources/data/$MODID" ]; then
            echo "ERROR: Missing data directory for mod $MODID"
            exit 1
          fi
          echo "OK: Data directory found"

      # ----------------------------
      # 7) Java + Gradle
      # ----------------------------
      - name: Set up Java 21 (Required for Minecraft 1.21+)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle (for wrapper generation)
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: "8.11.1"

      # ----------------------------
      # 8) Ensure Gradle wrapper exists
      # ----------------------------
      - name: Ensure Gradle wrapper exists
        run: |
          set -e
          if [ ! -f "./gradlew" ]; then
            echo "No ./gradlew found â€” generating wrapper with Gradle 8.11.1"
            gradle wrapper --gradle-version 8.11.1
          fi
          chmod +x ./gradlew
          ls -lah gradle/wrapper || true

      # ----------------------------
      # 9) Wrapper sanity check
      # ----------------------------
      - name: Validate Gradle wrapper jar
        run: |
          set -e
          test -f ./gradlew || (echo "ERROR: gradlew missing" && exit 1)
          test -f gradle/wrapper/gradle-wrapper.properties || (echo "ERROR: gradle-wrapper.properties missing" && exit 1)
          test -f gradle/wrapper/gradle-wrapper.jar || (echo "ERROR: gradle-wrapper.jar missing" && exit 1)
          unzip -l gradle/wrapper/gradle-wrapper.jar | grep -q "org/gradle/wrapper/GradleWrapperMain.class" \
            && echo "OK: GradleWrapperMain present" \
            || (echo "ERROR: GradleWrapperMain NOT in jar" && exit 1)

      # ----------------------------
      # 10) Build mod
      # ----------------------------
      - name: Build mod with Gradle
        id: build
        run: |
          set -e
          ./gradlew --version
          ./gradlew clean build remapJar --no-daemon --info 2>&1 | tee build.log
          ls -lah build/libs || true

          JAR_FILE=$(ls -1S build/libs/*.jar 2>/dev/null | grep -vE '(sources|javadoc|dev)\.jar$' | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "ERROR: No distributable jar produced"
            echo "=== BUILD LOG TAIL ==="
            tail -100 build.log
            exit 1
          fi

          echo "Found JAR: $JAR_FILE"
          echo "jar_file=$JAR_FILE" >> "$GITHUB_OUTPUT"
          echo "jar_name=$(basename "$JAR_FILE")" >> "$GITHUB_OUTPUT"

      # ----------------------------
      # 11) HARD validation (real mod)
      # ----------------------------
      - name: Validate real mod jar
        env:
          MODID: ${{ steps.modmeta.outputs.modid }}
          JAR: ${{ steps.build.outputs.jar_file }}
        run: |
          set -e
          echo "Validating JAR: $JAR"

          unzip -l "$JAR" | grep -q "fabric.mod.json" || (echo "Missing fabric.mod.json in jar" && exit 1)
          unzip -l "$JAR" | grep -q "\.class$" || (echo "No compiled classes in jar" && exit 1)
          unzip -l "$JAR" | grep -q "build-plan.json" || (echo "Missing build-plan.json in jar" && exit 1)

          unzip -l "$JAR" | grep -q "assets/$MODID/" || (echo "Missing assets/$MODID/" && exit 1)
          unzip -l "$JAR" | grep -q "data/$MODID/" || (echo "Missing data/$MODID/" && exit 1)

          echo "OK: All core files present"

      # ----------------------------
      # 11b) EXTRA QUALITY GATE
      # ----------------------------
      - name: Validate jar has lang/models/textures + reasonable size
        env:
          MODID: ${{ steps.modmeta.outputs.modid }}
          JAR: ${{ steps.build.outputs.jar_file }}
        run: |
          set -e
          echo "Jar file: $JAR"
          ls -lah "$JAR" || true
          JAR_SIZE=$(stat -c%s "$JAR")
          echo "Jar size bytes: $JAR_SIZE"

          unzip -l "$JAR" | grep -q "assets/$MODID/lang/en_us.json" \
            || (echo "Missing assets/$MODID/lang/en_us.json" && exit 1)
          unzip -l "$JAR" | grep -q "assets/$MODID/models/.*\.json" \
            || (echo "Missing any assets/$MODID/models/*.json" && exit 1)
          unzip -l "$JAR" | grep -q "assets/$MODID/textures/.*\.png" \
            || (echo "Missing any assets/$MODID/textures/*.png" && exit 1)

          CLASS_COUNT=$(unzip -l "$JAR" | grep -c "\.class$" || echo "0")
          echo "Class files in jar: $CLASS_COUNT"
          if [ "$CLASS_COUNT" -lt 5 ]; then
            echo "ERROR: Too few class files ($CLASS_COUNT). Expected at least 5 for a real mod."
            exit 1
          fi

          if [ "$JAR_SIZE" -lt 10000 ]; then
            echo "ERROR: Jar is suspiciously small (< 10KB). Likely missing content."
            exit 1
          fi

          echo "OK: Quality gate passed (size: ${JAR_SIZE} bytes, classes: ${CLASS_COUNT})"

      # ----------------------------
      # 11c) Validate loot tables have content (warn-only)
      # ----------------------------
      - name: Validate loot tables have content
        env:
          MODID: ${{ steps.modmeta.outputs.modid }}
          JAR: ${{ steps.build.outputs.jar_file }}
        run: |
          set -e
          TEMP_DIR=$(mktemp -d)
          unzip -q "$JAR" -d "$TEMP_DIR"

          LOOT_DIR="$TEMP_DIR/data/$MODID/loot_tables"
          if [ -d "$LOOT_DIR" ]; then
            for loot_file in $(find "$LOOT_DIR" -name "*.json" -type f 2>/dev/null); do
              if ! jq -e '.pools | length > 0' "$loot_file" > /dev/null 2>&1; then
                echo "WARNING: Empty loot table: $loot_file"
              fi
            done
          fi

          rm -rf "$TEMP_DIR"
          echo "OK: Loot table validation complete"

      # ----------------------------
      # 12) Upload artifact (GitHub)
      # ----------------------------
      - name: Upload mod jar (GitHub artifact)
        uses: actions/upload-artifact@v4
        with:
          name: minecraft-mod
          path: ${{ steps.build.outputs.jar_file }}
          retention-days: 7

      # ----------------------------
      # 12b) Upload to R2 (for in-app download)
      # ----------------------------
      - name: Upload mod jar to R2
        id: r2
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          set -e
          pip3 install awscli --quiet
          aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
          aws configure set region auto

          JAR_FILE="${{ steps.build.outputs.jar_file }}"
          JAR_NAME="${{ steps.build.outputs.jar_name }}"
          MOD_UUID="${{ steps.buildconfig.outputs.modUuid }}"
          TIMESTAMP=$(date +%s)
          KEY="compiled-mods/${MOD_UUID}/${TIMESTAMP}_${JAR_NAME}"

          echo "Uploading to R2: $KEY"
          aws s3 cp "$JAR_FILE" "s3://${R2_BUCKET_NAME}/${KEY}" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --content-type "application/java-archive"

          if [ -n "$R2_PUBLIC_URL" ]; then
            PUBLIC_URL="${R2_PUBLIC_URL}/${KEY}"
          else
            PUBLIC_URL="https://${R2_BUCKET_NAME}.r2.dev/${KEY}"
          fi

          echo "storage_path=$KEY" >> "$GITHUB_OUTPUT"
          echo "compiled_jar_url=$PUBLIC_URL" >> "$GITHUB_OUTPUT"
          echo "OK: Uploaded to $PUBLIC_URL"

      # ----------------------------
      # 13) Webhook success (STRICT + logs)
      # ----------------------------
      - name: Notify webhook (success)
        if: success()
        run: |
          set -e
          WEBHOOK_URL="${{ steps.buildconfig.outputs.webhookUrl }}"
          WEBHOOK_SECRET="${{ steps.buildconfig.outputs.webhookSecret }}"
          MOD_UUID="${{ steps.buildconfig.outputs.modUuid }}"
          STORAGE_PATH="${{ steps.r2.outputs.storage_path }}"
          COMPILED_URL="${{ steps.r2.outputs.compiled_jar_url }}"

          PAYLOAD=$(jq -n \
            --arg modId "$MOD_UUID" \
            --arg status "completed" \
            --arg storagePath "$STORAGE_PATH" \
            --arg storage_path "$STORAGE_PATH" \
            --arg compiledJarUrl "$COMPILED_URL" \
            --arg compiled_jar_url "$COMPILED_URL" \
            '{modId:$modId,status:$status,storagePath:$storagePath,storage_path:$storage_path,compiledJarUrl:$compiledJarUrl,compiled_jar_url:$compiled_jar_url}')

          echo "Webhook URL: $WEBHOOK_URL"
          echo "Payload: $PAYLOAD"

          RESPONSE=$(curl --fail-with-body -sS \
            -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "x-webhook-secret: $WEBHOOK_SECRET" \
            -d "$PAYLOAD" \
            -w "\n%{http_code}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Response code: $HTTP_CODE"
          echo "Response body: $BODY"

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "ERROR: Webhook returned non-2xx status"
            exit 1
          fi

      # ----------------------------
      # 14) Webhook failure (STRICT + logs)
      # ----------------------------
      - name: Notify webhook (failure)
        if: failure()
        run: |
          set -e
          WEBHOOK_URL="${{ steps.buildconfig.outputs.webhookUrl }}"
          WEBHOOK_SECRET="${{ steps.buildconfig.outputs.webhookSecret }}"
          MOD_UUID="${{ steps.buildconfig.outputs.modUuid }}"

          if [ -z "$WEBHOOK_URL" ]; then
            echo "No webhookUrl available; skipping webhook."
            exit 0
          fi

          ERROR_MSG="Build failed"
          if [ -f "build.log" ]; then
            ERROR_MSG=$(grep -iE "error:|FAILURE:|Exception" build.log | head -8 | tr '\n' ' ' | cut -c1-800 || echo "Build failed - see logs")
          fi

          PAYLOAD=$(jq -n \
            --arg modId "$MOD_UUID" \
            --arg status "failed" \
            --arg error "$ERROR_MSG" \
            --argjson storage_path null \
            --argjson storagePath null \
            '{modId:$modId,status:$status,error:$error,storage_path:$storage_path,storagePath:$storagePath}')

          echo "Webhook URL: $WEBHOOK_URL"
          echo "Payload: $PAYLOAD"

          curl --fail-with-body -sS \
            -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "x-webhook-secret: $WEBHOOK_SECRET" \
            -d "$PAYLOAD" || echo "Webhook notification failed (non-blocking)"

      # ----------------------------
      # 15) Upload build log on failure
      # ----------------------------
      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 3

