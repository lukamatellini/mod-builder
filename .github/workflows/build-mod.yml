name: Build Minecraft Mod (Main-Controlled)

on:
  workflow_dispatch:
    inputs:
      build_ref:
        description: "Branch to build (e.g. build/<id>/<timestamp>)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      # ----------------------------
      # 1) Checkout generated mod (the build/** branch passed in)
      # ----------------------------
      - name: Checkout generated mod project
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.build_ref }}
          fetch-depth: 1

      # ----------------------------
      # 2) Setup Node (JSON parsing)
      # ----------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ----------------------------
      # 3) Ensure unzip + file exist (for wrapper inspection)
      # ----------------------------
      - name: Ensure unzip + file are available
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y unzip file

      # ----------------------------
      # 4) Read build-config.json (includes webhookSecret + modId UUID)
      # ----------------------------
      - name: Read build-config.json
        id: buildconfig
        run: |
          set -e
          node -e "
            const fs = require('fs');

            const path = 'build-config.json';
            if (!fs.existsSync(path)) throw new Error('Missing build-config.json on build branch');

            const cfg = JSON.parse(fs.readFileSync(path, 'utf8'));

            // REQUIRED for webhook + DB update
            if (!cfg.modId) throw new Error('build-config.json missing modId (UUID)');
            if (!cfg.webhookUrl) throw new Error('build-config.json missing webhookUrl');
            if (!cfg.webhookSecret) throw new Error('build-config.json missing webhookSecret');
            if (!cfg.loader) throw new Error('build-config.json missing loader');
            if (!cfg.mcVersion) throw new Error('build-config.json missing mcVersion');

            const modId = String(cfg.modId).trim();
            const url = String(cfg.webhookUrl).trim();
            const secret = String(cfg.webhookSecret).trim();
            const loader = String(cfg.loader).trim();
            const mcVersion = String(cfg.mcVersion).trim();

            if (!/^https?:\\/\\//.test(url)) throw new Error('webhookUrl must start with http:// or https://');

            // Mask secret in logs
            console.log('::add-mask::' + secret);

            const out = process.env.GITHUB_OUTPUT;
            fs.appendFileSync(out, 'modId=' + modId + '\\n');
            fs.appendFileSync(out, 'webhookUrl=' + url + '\\n');
            fs.appendFileSync(out, 'webhookSecret=' + secret + '\\n');
            fs.appendFileSync(out, 'loader=' + loader + '\\n');
            fs.appendFileSync(out, 'mcVersion=' + mcVersion + '\\n');
          "

      # ----------------------------
      # 5) Guardrails (platform rules)
      # ----------------------------
      - name: Guardrails from build-config.json
        run: |
          set -e
          if [ "${{ steps.buildconfig.outputs.loader }}" != "fabric" ]; then
            echo "ERROR: loader must be fabric"
            exit 1
          fi
          case "${{ steps.buildconfig.outputs.mcVersion }}" in
            1.21.*) echo "OK: mcVersion ${{ steps.buildconfig.outputs.mcVersion }}" ;;
            *) echo "ERROR: mcVersion must be 1.21.x"; exit 1 ;;
          esac

      # ----------------------------
      # 6) Validate fabric.mod.json (still useful sanity check)
      # ----------------------------
      - name: Validate fabric.mod.json
        id: modmeta
        run: |
          set -e
          node -e "
            const fs = require('fs');
            const p = 'src/main/resources/fabric.mod.json';
            if (!fs.existsSync(p)) throw new Error('Missing ' + p);
            const meta = JSON.parse(fs.readFileSync(p, 'utf8'));
            if (!meta.id) throw new Error('fabric.mod.json missing id');
            if (!meta.depends || !meta.depends.minecraft) throw new Error('fabric.mod.json missing depends.minecraft');
            const mc = String(meta.depends.minecraft).replace(/\\s+/g,'');
            if (!(mc.includes('>=1.21') && mc.includes('<1.22'))) {
              throw new Error('Minecraft range must be >=1.21 <1.22');
            }
            const out = process.env.GITHUB_OUTPUT;
            fs.appendFileSync(out, 'modid=' + meta.id + '\\n');
          "

      # ----------------------------
      # 7) Java + Gradle
      # ----------------------------
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle (for wrapper generation)
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: "8.8"

      # ----------------------------
      # 8) Ensure Gradle wrapper exists
      # ----------------------------
      - name: Ensure Gradle wrapper exists
        run: |
          set -e
          if [ ! -f "./gradlew" ]; then
            echo "No ./gradlew found â€” generating wrapper with Gradle 8.8"
            gradle wrapper --gradle-version 8.8
          fi
          chmod +x ./gradlew
          echo "=== wrapper folder ==="
          ls -lah gradle/wrapper || true

      # ----------------------------
      # 9) Wrapper sanity check
      # ----------------------------
      - name: Validate Gradle wrapper jar
        run: |
          set -e
          test -f ./gradlew || (echo "ERROR: gradlew missing" && exit 1)
          test -f gradle/wrapper/gradle-wrapper.properties || (echo "ERROR: gradle-wrapper.properties missing" && exit 1)
          test -f gradle/wrapper/gradle-wrapper.jar || (echo "ERROR: gradle-wrapper.jar missing" && exit 1)
          file gradle/wrapper/gradle-wrapper.jar || true
          unzip -l gradle/wrapper/gradle-wrapper.jar | grep -q "org/gradle/wrapper/GradleWrapperMain.class" \
            && echo "OK: GradleWrapperMain present" \
            || (echo "ERROR: GradleWrapperMain NOT in jar (jar corrupt/wrong)" && exit 1)

      # ----------------------------
      # 10) Build mod
      # ----------------------------
      - name: Build mod with Gradle
        id: build
        run: |
          set -e
          ./gradlew --version
          ./gradlew clean build remapJar --no-daemon --info
          echo "Build output:"
          ls -lah build/libs || true
          JAR_FILE=$(ls -1S build/libs/*.jar \
            | grep -vE '(sources|javadoc|dev)\.jar$' \
            | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "ERROR: No distributable jar produced"
            exit 1
          fi
          echo "jar_file=$JAR_FILE" >> "$GITHUB_OUTPUT"
          echo "jar_name=$(basename "$JAR_FILE")" >> "$GITHUB_OUTPUT"

      # ----------------------------
      # 11) HARD validation (real mod)
      # ----------------------------
      - name: Validate real mod jar
        env:
          MODID: ${{ steps.modmeta.outputs.modid }}
          JAR: ${{ steps.build.outputs.jar_file }}
        run: |
          set -e
          unzip -l "$JAR" | grep -q "fabric.mod.json" || (echo "Missing fabric.mod.json in jar" && exit 1)
          unzip -l "$JAR" | grep -q "\.class$" || (echo "No compiled classes in jar" && exit 1)
          unzip -l "$JAR" | grep -q "build-plan.json" || (echo "Missing build-plan.json in jar" && exit 1)
          unzip -l "$JAR" | grep -q "assets/$MODID/" || (echo "Missing assets/$MODID/" && exit 1)
          unzip -l "$JAR" | grep -q "data/$MODID/" || (echo "Missing data/$MODID/" && exit 1)

      # ----------------------------
      # 12) Upload artifact (GitHub artifact)
      # ----------------------------
      - name: Upload mod jar
        uses: actions/upload-artifact@v4
        with:
          name: minecraft-mod
          path: ${{ steps.build.outputs.jar_file }}

      # ----------------------------
      # 13) Webhook success (includes secret + run_id so backend can fetch artifact)
      # ----------------------------
      - name: Notify webhook (success)
        if: success()
        run: |
          set -e
          WEBHOOK_URL="${{ steps.buildconfig.outputs.webhookUrl }}"
          WEBHOOK_SECRET="${{ steps.buildconfig.outputs.webhookSecret }}"
          MOD_UUID="${{ steps.buildconfig.outputs.modId }}"

          echo "Webhook URL: $WEBHOOK_URL"
          echo "Mod UUID: $MOD_UUID"
          echo "Run ID: ${{ github.run_id }}"

          if [ -z "$WEBHOOK_URL" ]; then
            echo "ERROR: webhookUrl is empty (check build-config.json)"
            exit 1
          fi
          if [ -z "$MOD_UUID" ]; then
            echo "ERROR: modId is empty (check build-config.json)"
            exit 1
          fi

          RESP=$(curl --fail-with-body -sS -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "x-webhook-secret: $WEBHOOK_SECRET" \
            -d "{\"status\":\"success\",\"modId\":\"$MOD_UUID\",\"branch\":\"${{ inputs.build_ref }}\",\"commit\":\"${GITHUB_SHA}\",\"workflowRunId\":${{ github.run_id }},\"artifactName\":\"minecraft-mod\"}" \
          ) || (echo "Webhook call failed" && exit 1)

          echo "Webhook response: $RESP"

      # ----------------------------
      # 14) Webhook failure (includes secret)
      # ----------------------------
      - name: Notify webhook (failure)
        if: failure()
        run: |
          set -e
          WEBHOOK_URL="${{ steps.buildconfig.outputs.webhookUrl }}"
          WEBHOOK_SECRET="${{ steps.buildconfig.outputs.webhookSecret }}"
          MOD_UUID="${{ steps.buildconfig.outputs.modId }}"

          if [ -z "$WEBHOOK_URL" ]; then
            echo "No webhookUrl available; skipping webhook."
            exit 0
          fi

          curl --fail-with-body -sS -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "x-webhook-secret: $WEBHOOK_SECRET" \
            -d "{\"status\":\"failed\",\"modId\":\"$MOD_UUID\",\"branch\":\"${{ inputs.build_ref }}\",\"commit\":\"${GITHUB_SHA}\",\"workflowRunId\":${{ github.run_id }},\"artifactName\":\"minecraft-mod\"}" \
          || true


