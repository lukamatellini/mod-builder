name: Build Minecraft Mod (Push Trigger)

on:
  push:
    branches:
      - "build/**"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      # ----------------------------
      # 1. Checkout generated mod
      # ----------------------------
      - name: Checkout generated mod project
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ----------------------------
      # 2. Setup Node (for JSON parsing)
      # ----------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ----------------------------
      # 3. Ensure unzip exists (safe)
      # ----------------------------
      - name: Ensure unzip is available
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y unzip

      # ----------------------------
      # 4. Read build-config.json
      # ----------------------------
      - name: Read build-config.json
        id: buildconfig
        run: |
          set -e
          node << 'EOF'
          const fs = require('fs');

          const path = 'build-config.json';
          if (!fs.existsSync(path)) {
            throw new Error('Missing build-config.json (Lovable must generate this)');
          }

          const cfg = JSON.parse(fs.readFileSync(path, 'utf8'));

          if (!cfg.webhookUrl) throw new Error('build-config.json missing webhookUrl');
          if (!cfg.loader) throw new Error('build-config.json missing loader');
          if (!cfg.mcVersion) throw new Error('build-config.json missing mcVersion');

          console.log(`webhookUrl=${cfg.webhookUrl}`);
          console.log(`loader=${cfg.loader}`);
          console.log(`mcVersion=${cfg.mcVersion}`);
          EOF > /tmp/buildcfg.txt

          while read line; do
            echo "$line" >> $GITHUB_OUTPUT
          done < /tmp/buildcfg.txt

      # ----------------------------
      # 5. Guardrails from build-config.json (recommended)
      # ----------------------------
      - name: Guardrails from build-config.json
        run: |
          set -e
          if [ "${{ steps.buildconfig.outputs.loader }}" != "fabric" ]; then
            echo "ERROR: loader must be fabric (got '${{ steps.buildconfig.outputs.loader }}')"
            exit 1
          fi

          case "${{ steps.buildconfig.outputs.mcVersion }}" in
            1.21.*) echo "OK: mcVersion allowed: ${{ steps.buildconfig.outputs.mcVersion }}" ;;
            *) echo "ERROR: mcVersion must be 1.21.x (got '${{ steps.buildconfig.outputs.mcVersion }}')"; exit 1 ;;
          esac

      # ----------------------------
      # 6. Validate Fabric metadata
      # ----------------------------
      - name: Validate fabric.mod.json
        id: modmeta
        run: |
          set -e
          node << 'EOF'
          const fs = require('fs');

          const p = 'src/main/resources/fabric.mod.json';
          if (!fs.existsSync(p)) throw new Error(`Missing ${p}`);

          const meta = JSON.parse(fs.readFileSync(p, 'utf8'));

          if (!meta.id) throw new Error('fabric.mod.json missing id');
          if (!meta.depends || !meta.depends.minecraft) {
            throw new Error('fabric.mod.json missing depends.minecraft');
          }

          const mc = String(meta.depends.minecraft).replace(/\s+/g,'');
          if (!(mc.includes('>=1.21') && mc.includes('<1.22'))) {
            throw new Error(`Minecraft range must be >=1.21 <1.22, found ${meta.depends.minecraft}`);
          }

          console.log(meta.id);
          EOF > /tmp/modid.txt

          echo "modid=$(cat /tmp/modid.txt)" >> $GITHUB_OUTPUT

      # ----------------------------
      # 7. Java + Gradle
      # ----------------------------
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: "8.4"

      # ----------------------------
      # 8. Build mod
      # ----------------------------
      - name: Build mod with Gradle
        id: build
        run: |
          set -e

          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            ./gradlew clean build remapJar --no-daemon --info
          else
            gradle clean build remapJar --no-daemon --info
          fi

          echo "Build output:"
          ls -lah build/libs || true

          JAR_FILE=$(ls -1S build/libs/*.jar \
            | grep -vE '(sources|javadoc|dev)\.jar$' \
            | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "ERROR: No distributable jar produced"
            exit 1
          fi

          echo "jar_file=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT

      # ----------------------------
      # 9. HARD validation (real mod)
      # ----------------------------
      - name: Validate real mod jar
        env:
          MODID: ${{ steps.modmeta.outputs.modid }}
          JAR: ${{ steps.build.outputs.jar_file }}
        run: |
          set -e

          unzip -l "$JAR" | grep -q "fabric.mod.json" || (echo "Missing fabric.mod.json in jar" && exit 1)
          unzip -l "$JAR" | grep -q "\.class$" || (echo "No compiled classes in jar" && exit 1)
          unzip -l "$JAR" | grep -q "build-plan.json" || (echo "Missing build-plan.json in jar" && exit 1)
          unzip -l "$JAR" | grep -q "assets/$MODID/" || (echo "Missing assets/$MODID/" && exit 1)
          unzip -l "$JAR" | grep -q "data/$MODID/" || (echo "Missing data/$MODID/" && exit 1)

      # ----------------------------
      # 10. Upload artifact (optional)
      # ----------------------------
      - name: Upload mod jar
        uses: actions/upload-artifact@v4
        with:
          name: minecraft-mod
          path: ${{ steps.build.outputs.jar_file }}

      # ----------------------------
      # 11. Webhook success
      # ----------------------------
      - name: Notify webhook (success)
        if: success()
        run: |
          set -e
          curl -X POST "${{ steps.buildconfig.outputs.webhookUrl }}" \
            -H "Content-Type: application/json" \
            -d "{\"status\":\"success\",\"modId\":\"${{ steps.modmeta.outputs.modid }}\",\"branch\":\"${GITHUB_REF_NAME}\",\"commit\":\"${GITHUB_SHA}\"}"

      # ----------------------------
      # 12. Webhook failure (SAFE if build-config read failed)
      # ----------------------------
      - name: Notify webhook (failure)
        if: failure()
        run: |
          set -e
          WEBHOOK="${{ steps.buildconfig.outputs.webhookUrl }}"
          if [ -z "$WEBHOOK" ]; then
            echo "No webhookUrl available (build-config.json missing or read failed). Skipping webhook."
            exit 0
          fi
          curl -X POST "$WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{\"status\":\"failed\",\"branch\":\"${GITHUB_REF_NAME}\",\"commit\":\"${GITHUB_SHA}\"}"








